{% extends "base.html" %}
{% load static %}

{% block title %}{{ project.view_name }} - Project Detail{% endblock %}
{% block extra_link %}
<link rel="stylesheet" href="{% static 'upload/css/project_detail_style.css' %}">
{% endblock %}
</head>

{% block content %}
<div class="header">
    <h1 class="project-title">{{ project.view_name }}</h1>
    <div class="project-meta">
        <div class="meta-item">
            <strong>Created:</strong> {{ project.created_at|date:"M d, Y H:i" }}
        </div>
        <div class="meta-item">
            <strong>Last Updated:</strong> {{ project.updated_at|date:"M d, Y H:i" }}
        </div>
        <div class="meta-item">
            <strong>Texture Parts:</strong> {{ project.texture_parts.count }}
        </div>
        {% if project.user %}
        <div class="meta-item">
            <strong>Created by:</strong> {{ project.user.username }}
        </div>
        {% endif %}
    </div>
    <div class="header-button">
        <a href="{% url 'project_list' %}" class="back-btn">Back to Projects</a>
        {% if user.is_authenticated and project.user == user %}
        <form id="generate-form" method="POST" action="{% url 'generate_images' %}">
            {% csrf_token %}
            <input type="hidden" name="project_id" value="{{ project.id }}">
            <button type="submit" class="generate-btn">Generate 360 images</button>
        </form>
        <form id="generate-form" method="POST" action="{% url 'generate_test_images' %}">
            {% csrf_token %}
            <input type="hidden" name="project_id" value="{{ project.id }}">
            <button type="submit" class="generate-btn">Generate test images</button>

        <div id="upload-loader" class="upload-loader" style="display: none">
            <div class="spinner"></div>
            <div class="loader-text">Uploading... Please wait</div>
        </div>
        </form>
        <a href="{% url 'delete_project' project.pk %}" class="delete-btn"
            onclick="return confirm('Are you sure you want to delete this project?')">Delete</a>
        {% endif %}
    </div>
</div>

<div class="model-section">
    <h2 class="section-title">
        <span>üì¶</span>
        3D Model File
    </h2>
    {% if project.model_file %}
    <div class="model-file">
        <div class="file-info">
            <div class="file-details">
                <div class="file-icon">üéØ</div>
                <h4>Blender Model File</h4>
            </div>
            <a href="{{ project.model_file.url }}" class="download-btn" download>Download</a>
        </div>
    </div>
    {% else %}
    <p class="no-textures">No model file uploaded</p>
    {% endif %}
</div>

{% if project.low_quality_model_file %}
<div class="model-section">
    <h2 class="section-title">
        <span>üì¶</span>
        3D Model File For 3D Views
    </h2>
    <div class="model-file">
        <div class="file-info">
            <div class="file-details">
                <div class="file-icon">üéØ</div>
                <h4>GLB Model File</h4>
            </div>
            <a href="{{ project.low_quality_model_file.url }}" class="download-btn" download>Download</a>
        </div>
    </div>
</div>
{% endif %}

<div class="model-section">
    <h2 class="section-title">
        <span>üé®</span>
        Texture Parts
    </h2>
    {% if texture_parts %}
    <div class="texture-parts">
        {% for part in texture_parts %}
        <div class="texture-part">
            <h3 class="part-title">{{ part.object_name }}</h3>
            {% if part.texture_files.all %}
            <div class="textures-grid">
                {% for texture in part.texture_files.all %}
                <div class="texture-item">
                    <img src="{{ texture.file.url }}" alt="{{ texture.original_filename }}" onclick="openModal(this)">
                    <div class="texture-info">
                        <div class="texture-name">{{ texture.original_filename }}</div>
                        <div class="texture-size">
                            {% if texture.file_size %}
                            {{ texture.file_size|filesizeformat }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <!-- add the texture download options -->
            {% else %}
            <p class="no-textures">No textures uploaded for this part</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="no-textures">No texture parts found</p>
    {% endif %}
</div>
<div class="model-section">
    <h2 class="section-title">
        <span>üñºÔ∏è</span>
        Output Rendered Images
    </h2>
    {% if output_files %}
    <div class="output-actions">
        <button id="download-all-btn" class="download-all-btn">üì¶ Download All as ZIP</button>
    </div>

    <div class="textures-grid">
        {% for file_url in output_files %}
        <div class="texture-item">
            <img src="{{ file_url }}" alt="Rendered Output" onclick="openModal(this)">
            <div class="texture-info">
                <div class="texture-actions">
                    <button class="download-single-btn" data-url="{{ file_url }}" title="Download this image">
                        ‚¨áÔ∏è Download
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <p class="no-textures">No output images found</p>
    {% endif %}
</div>

<div id="imageModal" class="modal" onclick="closeModal()">
    <div class="texture-pop-up">
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>
</div>

<div id="zip-loader" class="upload-loader" style="display: none">
    <div class="spinner"></div>
    <div class="loader-text">Creating ZIP file... Please wait</div>
</div>

</div>
{% endblock %}

{% block script %}
<script>
    window.openModal = function(imgElement) {
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImage");
        modal.style.display = "block";
        modalImg.src = imgElement.src;
    }

    window.closeModal = function() {
        document.getElementById("imageModal").style.display = "none";
    }

    // Show loader for generate buttons
    const buttons = document.getElementsByClassName('generate-btn');
    for (let i = 0; i < buttons.length; i++) {
        buttons[i].addEventListener("click", function () {
            document.getElementById("upload-loader").style.display = "flex"
        })
    }

    // Download single image and modal functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Modal functionality with event delegation
        document.addEventListener('click', function(e) {
            // Open modal when clicking on images with modal-trigger class
            if (e.target.classList.contains('modal-trigger')) {
                const modal = document.getElementById("imageModal");
                const modalImg = document.getElementById("modalImage");
                modal.style.display = "block";
                modalImg.src = e.target.src;
            }
            
            // Close modal when clicking on close button or modal background
            if (e.target.classList.contains('close') || e.target.id === 'imageModal') {
                document.getElementById("imageModal").style.display = "none";
            }
        });
	});

        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.getElementById("imageModal").style.display = "none";
            }
        });

        // Download single image buttons
        const downloadButtons = document.querySelectorAll('.download-single-btn');
        downloadButtons.forEach(button => {
            button.addEventListener('click', function() {
                const url = this.getAttribute('data-url');
                const filename = url.split('/').pop() || 'rendered_image.png';
                
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
	//    function openModal(imgElement) {
	//        const modal = document.getElementById("imageModal");
	//        const modalImg = document.getElementById("modalImage");
	//        modal.style.display = "block";
	//        modalImg.src = imgElement.src;
	//    }

	//    function closeModal() {
	//        document.getElementById("imageModal").style.display = "none";
	//    }


	// const buttons = document.getElementsByClassName('generate-btn');
	// for (let i = 0; i < buttons.length; i++) {
	// 	buttons[i].addEventListener("click", function () {
	// 		document.getElementById("upload-loader").style.display = "flex"
	// 	})
	// }


	// const downloadButtons = document.querySelectorAll('.download-single-btn');
	// downloadButtons.forEach(button => {
	// 	button.addEventListener('click', function() {
	// 		const url = this.getAttribute('data-url');
	// 		const filename = url.split('/').pop() || 'rendered_image.png';
			
	// 		const link = document.createElement('a');
	// 		link.href = url;
	// 		link.download = filename;
	// 		document.body.appendChild(link);
	// 		link.click();
	// 		document.body.removeChild(link);
	// 	});


	const downloadAllBtn = document.getElementById('download-all-btn');
	if (downloadAllBtn) {
		downloadAllBtn.addEventListener('click', function() {
			// Show loading spinner
			document.getElementById('zip-loader').style.display = 'flex';

			// Make request to backend to create ZIP
			fetch('{% url "download_output_zip" project.id %}', {
				method: 'GET',
				headers: {
					'X-CSRFToken': '{{ csrf_token }}'
				}
			})
				.then(response => {
					if (response.ok) {
						return response.blob();
					}
					throw new Error('Failed to create ZIP file');
				})
				.then(blob => {
					// Create download link
					const url = window.URL.createObjectURL(blob);
					const link = document.createElement('a');
					link.href = url;
					link.download = '{{ project.view_name }}_output_images.zip';
					document.body.appendChild(link);
					link.click();
					document.body.removeChild(link);
					window.URL.revokeObjectURL(url);
				})
				.catch(error => {
					console.error('Error:', error);
					alert('Failed to download ZIP file. Please try again.');
				})
				.finally(() => {
					// Hide loading spinner
					document.getElementById('zip-loader').style.display = 'none';
				});
		});
	}
</script>
{% endblock %}
